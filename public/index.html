<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>3D Объём — Telegram WebApp</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Manrope:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css?v=12" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
  </head>
  <body>
    <div class="glow"></div>
    <div class="app">
      <header class="hero">
        <div class="brand">3D калькулятор объема моделей от Top Form.</div>
        <div class="metal-bar" id="metal-bar">
          <div class="metal-title">
            Металлы сегодня <span id="metal-date">—</span>
          </div>
          <div class="metal-items">
            <div class="metal-chip">
              <span>Au</span>
              <strong id="metal-au">—</strong>
              <small>₽/г</small>
            </div>
            <div class="metal-chip">
              <span>Ag</span>
              <strong id="metal-ag">—</strong>
              <small>₽/г</small>
            </div>
            <div class="metal-chip">
              <span>Pt</span>
              <strong id="metal-pt">—</strong>
              <small>₽/г</small>
            </div>
            <div class="metal-chip">
              <span>Pd</span>
              <strong id="metal-pd">—</strong>
              <small>₽/г</small>
            </div>
          </div>
        </div>
        <div>
          <p>
            Загрузи STL, получи объём в см³ и вес восковки. Скриншот
            сохраняется автоматически.
          </p>
        </div>
      </header>

      <section class="workspace">
        <div class="panel controls">
          <div class="upload" id="drop-zone">
            <input id="file-input" type="file" accept=".stl" multiple />
            <div class="upload-info">
              <h3>Перетащи STL сюда</h3>
              <p>можно выбрать сразу несколько файлов</p>
            </div>
            <button class="btn" id="file-button">Выбрать STL</button>
          </div>

          <div class="settings">
            <div class="field">
              <label for="units">Единицы модели</label>
              <select id="units">
                <option value="mm">мм</option>
                <option value="cm">см</option>
              </select>
            </div>
            <div class="field">
              <label>Выбрано</label>
              <div class="value" id="file-name">—</div>
            </div>
          </div>

          <div class="file-list">
            <div class="file-list-title">
              Файлы <span id="file-count">0</span>
            </div>
            <div class="file-list-body" id="file-list"></div>
          </div>

          <div class="metrics">
            <div class="metric">
              <span>Объём (выбранный)</span>
              <strong id="volume">0.00</strong>
              <small>см³</small>
            </div>
            <div class="metric">
              <span>Вес восковки (выбранный)</span>
              <strong id="weight">0.00</strong>
              <small>г</small>
            </div>
            <div class="metric">
              <span>Суммарный объём</span>
              <strong id="volume-total">0.00</strong>
              <small>см³</small>
            </div>
            <div class="metric">
              <span>Суммарный вес</span>
              <strong id="weight-total">0.00</strong>
              <small>г</small>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="capture">Скриншот модели</button>
            <a class="btn ghost" id="download" download="model.png">Скачать PNG</a>
            <button class="btn ghost" id="share-web" type="button">
              Поделиться (браузер)
            </button>
            <button class="btn ghost" id="share-tg" type="button">
              Поделиться (Telegram)
            </button>
          </div>

          <p class="note" id="status">
            Загрузите STL‑модель, чтобы начать расчёт.
          </p>
          <p class="error" id="error"></p>
        </div>

        <div class="panel viewer">
          <div class="viewer-wrap">
            <canvas id="viewer"></canvas>
            <div class="empty" id="empty">Модель ещё не загружена</div>
          </div>
          <div class="mobile-controls">
            <div class="control-row">
              <button class="btn ghost" id="pick-file-mobile" type="button">
                Выбрать STL
              </button>
              <button class="btn ghost" id="reset-view" type="button">
                Сброс вида
              </button>
            </div>
            <div class="control-row">
              <button class="btn ghost" id="rotate-left" type="button">⟲</button>
              <button class="btn ghost" id="rotate-right" type="button">⟳</button>
              <button class="btn ghost" id="rotate-up" type="button">↑</button>
              <button class="btn ghost" id="rotate-down" type="button">↓</button>
            </div>
            <div class="control-row">
              <button class="btn ghost" id="zoom-in" type="button">＋</button>
              <button class="btn ghost" id="zoom-out" type="button">－</button>
            </div>
          </div>
          <div class="snapshot">
            <div class="snapshot-title">Скриншот</div>
            <img id="snapshot" alt="Скриншот модели" />
          </div>
        </div>
      </section>

      <footer class="footer">
        <div class="daily-counter">
          <div class="counter-card">
            <div class="counter-title">Telegram</div>
            <div class="counter-row">
              <span>Всего</span>
              <strong id="tg-total">—</strong>
            </div>
            <div class="counter-row">
              <span>Уники</span>
              <strong id="tg-unique">—</strong>
            </div>
            <div class="counter-row">
              <span>Повторы</span>
              <strong id="tg-repeat">—</strong>
            </div>
          </div>
          <div class="counter-card">
            <div class="counter-title">Браузер</div>
            <div class="counter-row">
              <span>Всего</span>
              <strong id="web-total">—</strong>
            </div>
            <div class="counter-row">
              <span>Уники</span>
              <strong id="web-unique">—</strong>
            </div>
            <div class="counter-row">
              <span>Повторы</span>
              <strong id="web-repeat">—</strong>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <script>
      window.__APP_READY__ = false;
      window.__APP_ERROR__ = null;

      window.addEventListener("error", (event) => {
        window.__APP_ERROR__ = event.message || "Unknown error";
      });

      const script = document.createElement("script");
      script.src = `app.js?v=25`;
      script.defer = true;
      script.onload = () => {
        setTimeout(() => {
          if (!window.__APP_READY__) {
            const el = document.getElementById("error");
            if (el) {
              el.textContent =
                "app.js загрузился, но не выполнился. Откройте WebApp в браузере и посмотрите ошибки.";
            }
          }
        }, 50);
      };
      script.onerror = () => {
        const el = document.getElementById("error");
        if (el) {
          el.textContent =
            "app.js не загрузился. Проверьте доступность файла app.js.";
        }
      };
      document.head.appendChild(script);

      setTimeout(() => {
        if (!window.__APP_READY__) {
          const el = document.getElementById("error");
          if (el) {
            el.textContent =
              window.__APP_ERROR__ ||
              "app.js не загрузился. Проверьте доступность файла app.js.";
          }
        }
      }, 2000);
    </script>
  </body>
</html>
